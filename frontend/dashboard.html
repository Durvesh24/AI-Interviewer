<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Interviewer</title>
    <!-- Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Dashboard specific overrides */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            overflow-x: auto;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            font-weight: 600;
            white-space: nowrap;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .tab-btn:hover {
            color: var(--primary);
            background: rgba(var(--primary), 0.05);
            /* fix rgba syntax if simple hex */
            background: var(--bg-card);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            border-radius: 0;
            background: transparent;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(var(--primary), 0.1);
            /* fallback */
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info h4 {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-info .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-main);
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span style="font-size: 2rem;">ü§ñ</span>
                <span>AI Interview Coach</span>
            </a>

            <button class="mobile-toggle" aria-label="Toggle Menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>

            <div class="nav-links">
                <span id="user-display" style="font-weight: 500; color: var(--text-main);"></span>
                <a href="profile.html" class="nav-link" style="display: flex; align-items: center; gap: 0.25rem;">
                    <span>üë§</span> My Profile
                </a>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle Dark Mode">
                    <span>üåô</span>
                </button>
                <button onclick="logout()" class="btn btn-secondary"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">Logout</button>
            </div>
        </div>
    </nav>

    <div class="app-container" style="margin-top: 2rem; margin-bottom: 4rem;">
        <header class="dashboard-header">
            <div class="welcome-text">
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">My Dashboard</h1>
                <p style="color: var(--text-muted);">Track your progress and interview history.</p>
            </div>
            <a href="mock-interview.html" id="startInterviewBtn" class="btn btn-primary">+ Start New Interview</a>
        </header>

        <!-- Learner Stats Section -->
        <section id="learner-stats" class="hidden">
            <div class="stats-grid">
                <div class="card stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-info">
                        <h4>Total Interviews</h4>
                        <div class="value" id="stat-total">0</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-info">
                        <h4>Average Score</h4>
                        <div class="value" id="stat-avg">0.0</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-info">
                        <h4>Highest Score</h4>
                        <div class="value" id="stat-high">0</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üíº</div>
                    <div class="stat-info">
                        <h4>Top Role</h4>
                        <div class="value" id="stat-role" style="font-size: 1.1rem;">-</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <section id="dashboard-nav">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('interviews', this)">My Interviews</button>
                <button id="resume-analytics-tab" class="tab-btn" onclick="switchTab('resume-reviews', this)">Resume
                    Analytics</button>
                <button id="analytics-tab" class="tab-btn" onclick="switchTab('performance', this)">Performance
                    Stats</button>
                <button id="admin-tab-btn" class="tab-btn hidden" onclick="switchTab('users', this)">User
                    Management</button>
            </div>
        </section>

        <!-- Interviews Tab -->
        <section id="interviews-view">
            <h3 style="margin-bottom: 1.5rem;">Practice Interviews</h3>
            <div id="practice-interview-list">
                <div class="text-center" style="padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>

            <h3 style="margin: 3rem 0 0.5rem;">Resume-Based Interviews</h3>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem;">
                Interviews started from <a href="resume-review.html" style="color: var(--primary);">Resume Analysis</a>
                using your uploaded CV appear here.
            </p>
            <div id="resume-interview-list">
                <div class="text-center" style="padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
        </section>

        <!-- Resume Reviews Tab -->
        <section id="resume-reviews-view" class="hidden">
            <h3 style="margin-bottom: 1.5rem;">Resume Analysis History</h3>
            <div id="resume-review-list">
                <div class="text-center" style="padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
        </section>

        <!-- Performance Tab -->
        <section id="performance-view" class="hidden">
            <h3 style="margin-bottom: 1.5rem;">Performance Analytics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                <div class="card">
                    <h4 style="margin-bottom: 1rem;">Progress Over Time</h4>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 1rem;">Average Score by Role</h4>
                    <canvas id="rolePerformanceChart"></canvas>
                </div>
            </div>
        </section>

        <!-- User Management Tab (Admin Only) -->
        <section id="users-view" class="hidden">
            <h3 style="margin-bottom: 1.5rem;">Manage Users</h3>
            <div id="user-list">
                <div class="text-center" style="padding: 2rem; color: var(--text-muted);">Loading users...</div>
            </div>
        </section>
    </div>

    <!-- Modal -->

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-grid">
            <div class="footer-col">
                <div class="logo">ü§ñ AI Interview Coach</div>
            </div>
            <div class="footer-col">
                <p>&copy; <span id="currentYear"></span></p>
            </div>
        </div>
    </footer>

    <!-- Generic Modal for Details -->
    <div id="detailsModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal-content card" onclick="event.stopPropagation()"
            style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 id="modalTitle">Details</h3>
                <button onclick="closeModal()"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Content injected here -->
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Main JS -->
    <script src="js/main.js"></script>

    <script>
        const token = sessionStorage.getItem('token');
        const role = sessionStorage.getItem('userRole');
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'http://localhost:5000' : '';
        let allInterviewsData = []; // Store for performance charts

        if (!token) { window.location.href = 'login.html'; }
        document.getElementById('user-display').innerText = sessionStorage.getItem('userEmail') || 'User';

        if (role === 'admin') {
            document.querySelector('.welcome-text h1').innerText = "Admin Control Center";
            document.getElementById('admin-tab-btn').classList.remove('hidden');
            document.getElementById('startInterviewBtn').style.display = 'none';
            document.getElementById('analytics-tab').style.display = 'none';
        }

        // Tab Switching
        window.switchTab = function (tabName, btn) {
            // Hide all sections
            ['interviews', 'resume-reviews', 'performance', 'users'].forEach(t => {
                const el = document.getElementById(t + '-view');
                if (el) el.classList.add('hidden');
            });
            // Show selected
            document.getElementById(tabName + '-view').classList.remove('hidden');

            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Load data if needed
            if (tabName === 'users') fetchUsers();
            if (tabName === 'resume-reviews') fetchResumeReviews();
            if (tabName === 'performance') renderPerformanceCharts();
        }

        async function fetchInterviews() {
            const errMsg = '<div class="text-center" style="color:var(--error);">Failed to load data. Please refresh.</div>';
            try {
                const endpoint = role === 'admin' ? `${API_BASE_URL}/admin/all-interviews` : `${API_BASE_URL}/my-interviews`;
                const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.status === 401 || res.status === 403) { logout(); return; }
                const data = await res.json();

                if (!res.ok) {
                    console.error('Fetch interviews error:', data);
                    document.getElementById('practice-interview-list').innerHTML = errMsg;
                    document.getElementById('resume-interview-list').innerHTML = errMsg;
                    return;
                }

                if (!Array.isArray(data)) {
                    document.getElementById('practice-interview-list').innerHTML = errMsg;
                    document.getElementById('resume-interview-list').innerHTML = errMsg;
                    return;
                }

                if (role !== 'admin') {
                    document.getElementById('learner-stats').classList.remove('hidden');
                    calculateLearnerStats(data);
                }

                allInterviewsData = data;

                const practiceInterviews = data.filter(i => !i.type || i.type === 'standard');
                const resumeInterviews = data.filter(i => i.type === 'resume');

                renderList(practiceInterviews, 'practice-interview-list');
                renderList(resumeInterviews, 'resume-interview-list');
            } catch (e) {
                console.error('fetchInterviews error:', e);
                document.getElementById('practice-interview-list').innerHTML = errMsg;
                document.getElementById('resume-interview-list').innerHTML = errMsg;
            }
        }

        function renderList(data, containerId) {
            const container = document.getElementById(containerId);
            if (data.length === 0) {
                container.innerHTML = '<div class="text-center" style="color:var(--text-muted);">No interviews found.</div>';
                return;
            }
            container.innerHTML = data.map(i => {
                const date = new Date(i.date).toLocaleDateString();
                const avgScore = i.scores?.length ? (i.scores.reduce((a, b) => a + b, 0) / i.scores.length).toFixed(1) : 0;
                let badgeClass = avgScore >= 7 ? 'high' : (avgScore >= 5 ? 'med' : 'low');

                // For Admin: Show User Email
                const title = role === 'admin' && i.email ? `${i.role} <span style="font-weight:400; font-size:0.85em; color:var(--text-muted);">(${i.email})</span>` : i.role;

                return `
                    <div class="interview-card">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">${title}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">${date} - ${i.difficulty || 'Normal'}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="score-badge ${badgeClass}" style="margin-right: 0.5rem;">${avgScore}/10</span>
                            
                            <button onclick="viewInterviewDetails('${i.id}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üëÅÔ∏è View</button>
                            <button onclick="downloadInterviewPDF('${i.id}', '${i.role}', '${date}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" title="Download Report">‚¨áÔ∏è PDF</button>
                            
                            ${role !== 'admin' ?
                        `<button onclick="showToast('Retake feature coming soon!', 'info')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Retake</button>` :
                        `<button onclick="deleteItem('interviews', '${i.id}')" class="btn btn-secondary" style="color:var(--error); border-color:var(--error); padding: 0.25rem 0.5rem;">Delete</button>`
                    }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // PDF Download Logic
        async function downloadInterviewPDF(interviewId, roleTitle, date) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            try {
                showToast("Generating full report with AI feedback... please wait.", "info");

                // 1. Fetch Interview Details
                const res = await fetch(`${API_BASE_URL}/my-interviews/${interviewId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to fetch interview details');
                const interview = await res.json();

                // 2. Fetch Ideal Answers (AI Generated)
                let idealAnswers = [];
                try {
                    const idealRes = await fetch(`${API_BASE_URL}/ideal-answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ interviewId })
                    });

                    if (idealRes.ok) {
                        const idealData = await idealRes.json();
                        idealAnswers = idealData.idealAnswers || [];
                    } else {
                        console.warn("Could not fetch ideal answers, possibly incomplete interview.");
                    }
                } catch (err) {
                    console.error("Ideal answer fetch failed", err);
                }

                // 3. Generate PDF
                // Header
                doc.setFontSize(22);
                doc.setTextColor(79, 70, 229); // Primary Color
                doc.text("AI Interview Report", 20, 20);

                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text(`Role: ${roleTitle}`, 20, 35);
                doc.text(`Date: ${date}`, 20, 42);

                if (interview.scores && interview.scores.length > 0) {
                    const validScores = interview.scores.filter(s => typeof s === 'number');
                    const avg = validScores.length ? (validScores.reduce((a, b) => a + b, 0) / validScores.length).toFixed(1) : 0;
                    doc.text(`Average Score: ${avg}/10`, 20, 49);
                }

                // Content Table construction
                const questions = interview.questions || [];
                const userAnswers = interview.answers || [];
                const scores = interview.scores || [];

                const tableBody = questions.map((q, index) => {
                    const uAns = userAnswers[index] || "No answer provided.";
                    const feedback = (interview.feedbacks && interview.feedbacks[index]) ? interview.feedbacks[index] : "No feedback recorded.";
                    const combined = uAns + "\n\n---\nAI Feedback:\n" + feedback;
                    const iAnsRaw = idealAnswers[index];
                    const iAns = (iAnsRaw && iAnsRaw.idealAnswer) ? iAnsRaw.idealAnswer : (typeof iAnsRaw === 'string' ? iAnsRaw : "Detailed answer not available.");
                    const score = scores[index] !== undefined ? scores[index] : '-';

                    return [
                        `Q${index + 1}: ${q}`,
                        combined,
                        iAns,
                        score
                    ];
                });

                doc.autoTable({
                    startY: 60,
                    head: [['Question', 'Your Answer & Feedback', 'Ideal Answer (10/10)', 'Score']],
                    body: tableBody,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] },
                    styles: { fontSize: 9, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 40 }, // Question
                        1: { cellWidth: 55 }, // User Answer + FB
                        2: { cellWidth: 70 }, // Ideal Answer
                        3: { cellWidth: 15, halign: 'center' } // Score
                    },
                    didDrawPage: function (data) {
                        // Footer on each page
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        doc.text("Generated by AI Interview Coach", 20, doc.internal.pageSize.height - 10);
                    }
                });

                doc.save(`Interview_Report_${roleTitle.replace(/\s+/g, '_')}_${date.replace(/\//g, '-')}.pdf`);
                showToast('Report downloaded successfully!', 'success');

            } catch (e) {
                console.error(e);
                showToast('Failed to generate PDF: ' + e.message, 'error');
            }
        }

        // Stats Calculation
        function calculateLearnerStats(data) {
            document.getElementById('stat-total').innerText = data.length;
            if (data.length > 0) {
                const allScores = data.flatMap(i => i.scores || []);
                if (allScores.length) {
                    const avg = (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1);
                    document.getElementById('stat-avg').innerText = avg;
                    document.getElementById('stat-high').innerText = Math.max(...allScores);
                }
            }
        }



        async function fetchResumeReviews() {
            const container = document.getElementById('resume-review-list');
            try {
                const endpoint = role === 'admin' ? `${API_BASE_URL}/admin/all-resume-reviews` : `${API_BASE_URL}/my-resume-reviews`;
                const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.status === 401) { logout(); return; }
                const data = await res.json();

                if (!res.ok || !Array.isArray(data)) {
                    console.error('Fetch resume reviews error:', data);
                    container.innerHTML = '<div class="text-center" style="color:var(--error);">Failed to load. Please refresh.</div>';
                    return;
                }

                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center" style="color:var(--text-muted);">No resume reviews found.</div>';
                    return;
                }

                container.innerHTML = data.map(r => {
                    const date = new Date(r.date).toLocaleDateString();
                    // Admin sees email, user sees just role
                    const title = role === 'admin' ? `${r.role} (${r.email})` : r.role;
                    const score = r.ats_score || 0;
                    let badgeClass = score >= 80 ? 'high' : (score >= 60 ? 'med' : 'low');

                    return `
                        <div class="interview-card">
                            <div>
                                <div style="font-weight: 700; margin-bottom: 0.25rem;">${title}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">${date}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="score-badge ${badgeClass}" style="background:none; border: 1px solid currentColor; margin-right: 0.5rem;">ATS: ${score}%</span>
                                
                                <button onclick="viewResumeDetails('${r.id}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;">üëÅÔ∏è View</button>
                                
                                ${role === 'admin' ?
                            `<button onclick="deleteItem('resume-reviews', '${r.id}')" class="btn btn-secondary" style="color:var(--error); border-color:var(--error); padding: 0.25rem 0.5rem;">Delete</button>` : ''
                        }
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('fetchResumeReviews error:', e);
                container.innerHTML = '<div class="text-center" style="color:var(--error);">Failed to load. Please refresh.</div>';
            }
        }

        async function fetchUsers() {
            if (role !== 'admin') return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                const container = document.getElementById('user-list');
                container.innerHTML = data.map(u => `
                    <div class="interview-card">
                        <div>
                            <div style="font-weight: 700;">${u.email}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Role: ${u.role} | Last Login: ${u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never'}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${u.role !== 'admin' ? `<button onclick="deleteItem('users', '${u.id}')" class="btn btn-secondary" style="color:var(--error); border-color:var(--error); padding: 0.25rem 0.5rem;">Delete</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/${type}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    showToast('Deleted successfully', 'success');
                    if (type === 'users') fetchUsers();
                    else if (type === 'resume-reviews') fetchResumeReviews();
                } else {
                    showToast('Failed to delete', 'error');
                }
            } catch (e) { console.error(e); }
        }

        function renderPerformanceCharts() {
            if (allInterviewsData.length === 0) {
                document.getElementById('performanceChart').parentElement.innerHTML = '<p style="color:var(--text-muted);text-align:center;">No interview data yet.</p>';
                document.getElementById('rolePerformanceChart').parentElement.innerHTML = '';
                return;
            }

            // Chart 1: Progress over time (sorted by date)
            const sorted = [...allInterviewsData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const timeLabels = sorted.map(i => new Date(i.date).toLocaleDateString());
            const timeScores = sorted.map(i => i.scores.length ? (i.scores.reduce((a, b) => a + b, 0) / i.scores.length).toFixed(1) : 0);

            const ctx1 = document.getElementById('performanceChart');
            if (ctx1._chartInstance) ctx1._chartInstance.destroy();
            ctx1._chartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{ label: 'Avg Score', data: timeScores, borderColor: '#4F46E5', backgroundColor: 'rgba(79,70,229,0.1)', tension: 0.4, fill: true, pointBackgroundColor: '#4F46E5' }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 10, ticks: { stepSize: 2 } } } }
            });

            // Chart 2: Average score by role
            const roleMap = {};
            allInterviewsData.forEach(i => {
                if (!roleMap[i.role]) roleMap[i.role] = [];
                i.scores.forEach(s => roleMap[i.role].push(s));
            });
            const roleLabels = Object.keys(roleMap);
            const roleAvgs = roleLabels.map(r => (roleMap[r].reduce((a, b) => a + b, 0) / roleMap[r].length).toFixed(1));
            const colors = roleLabels.map((_, idx) => `hsl(${idx * 50 + 220}, 65%, 55%)`);

            const ctx2 = document.getElementById('rolePerformanceChart');
            if (ctx2._chartInstance) ctx2._chartInstance.destroy();
            ctx2._chartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: roleLabels,
                    datasets: [{ label: 'Avg Score', data: roleAvgs, backgroundColor: colors, borderRadius: 6 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 10 } } }
            });
        }

        // --- View Details Logic ---

        async function viewInterviewDetails(id) {
            try {
                showToast("Loading details...");
                const res = await fetch(`${API_BASE_URL}/my-interviews/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Failed to load");

                document.getElementById('modalTitle').innerText = `Interview: ${data.role} (${new Date(data.date).toLocaleDateString()})`;

                // Build Q&A HTML (no ideal answers yet)
                let content = `<div id="qa-container" style="display:flex; flex-direction:column; gap: 1.5rem;">`;
                data.questions.forEach((q, i) => {
                    const score = data.scores[i] !== undefined ? data.scores[i] : '-';
                    const answer = data.answers[i] || '<span style="color:var(--text-muted); font-style:italic;">No answer recorded</span>';
                    const feedback = (data.feedbacks && data.feedbacks[i]) ? data.feedbacks[i] : '<span style="color:var(--text-muted); font-style:italic;">No feedback recorded</span>';
                    content += `
                        <div id="qa-${i}" style="padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                            <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Q${i + 1}: ${q}</div>
                            <div style="background: var(--bg-body); padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                                <strong>Your Answer:</strong>
                                <p style="margin: 0.5rem 0 0; color: var(--text-main);">${answer}</p>
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color);">
                                    <strong>AI Feedback:</strong>
                                    <p style="margin: 0.5rem 0 0; color: var(--text-main); font-size: 0.95rem;">${feedback}</p>
                                </div>
                            </div>
                            <div id="ideal-${i}" style="background: rgba(16,185,129,0.07); border-left: 3px solid #10B981; padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem; display:none;">
                                <strong style="color:#10B981;">üí° Ideal Answer:</strong>
                                <p style="margin: 0.5rem 0 0; color: var(--text-main);">Loading...</p>
                            </div>
                            <div style="font-size: 0.9rem;">
                                <strong>Score:</strong> <span class="score-badge ${score >= 7 ? 'high' : (score >= 5 ? 'med' : 'low')}">${score}/10</span>
                            </div>
                        </div>`;
                });
                content += `</div>
                    <div style="text-align:center; margin-top: 1.5rem;">
                        <button id="loadIdealBtn" onclick="loadIdealAnswers('${id}', ${data.questions.length})" class="btn btn-secondary">üí° Show Ideal Answers</button>
                    </div>`;

                document.getElementById('modalBody').innerHTML = content;
                document.getElementById('detailsModal').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                showToast("Error loading details", "error");
            }
        }

        window.loadIdealAnswers = async function (interviewId, questionCount) {
            const btn = document.getElementById('loadIdealBtn');
            btn.disabled = true;
            btn.innerText = '‚è≥ Generating with AI...';
            try {
                const res = await fetch(`${API_BASE_URL}/ideal-answers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ interviewId })
                });
                const data = await res.json();
                const idealAnswers = data.idealAnswers || [];

                for (let i = 0; i < questionCount; i++) {
                    const el = document.getElementById(`ideal-${i}`);
                    if (el) {
                        el.style.display = 'block';
                        const item = idealAnswers[i] || {};
                        el.querySelector('p').innerText = item.idealAnswer || 'Not available.';
                    }
                }
                btn.style.display = 'none';
            } catch (e) {
                btn.disabled = false;
                btn.innerText = 'üí° Show Ideal Answers';
                showToast('Failed to load ideal answers.', 'error');
            }
        }

        async function viewResumeDetails(id) {
            try {
                showToast("Loading analysis...");
                const res = await fetch(`${API_BASE_URL}/my-resume-reviews/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || "Failed to load");

                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');

                modalTitle.innerText = `Resume Analysis: ${data.role}`;

                const stats = data.data || {};
                const keywords = stats.keywordsMatched || [];
                const missing = stats.missingSkills || [];
                const issues = stats.formattingIssues || [];

                let content = `
                    <div style="text-align:center; margin-bottom: 2rem;">
                         <div style="font-size: 3rem; font-weight: 800; color: ${data.ats_score >= 80 ? '#10B981' : (data.ats_score >= 60 ? '#F59E0B' : '#EF4444')};">
                            ${data.ats_score}%
                         </div>
                         <div style="color: var(--text-muted);">ATS Compatibility Score</div>
                    </div>

                    <div style="display: grid; gap: 1.5rem;">
                         <div class="card" style="border-left: 4px solid #10B981;">
                            <h4 style="color: #10B981; margin-bottom: 0.5rem;">‚úÖ Matched Keywords</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${keywords.length ? keywords.map(k => `<span style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">${k}</span>`).join('') : 'None'}
                            </div>
                         </div>
                         
                         <div class="card" style="border-left: 4px solid #EF4444;">
                            <h4 style="color: #EF4444; margin-bottom: 0.5rem;">‚ö†Ô∏è Missing Skills</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${missing.length ? missing.map(k => `<span style="background: rgba(239, 68, 68, 0.1); color: #EF4444; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">${k}</span>`).join('') : 'None'}
                            </div>
                         </div>

                         <div class="card">
                            <h4 style="margin-bottom: 0.5rem;">üìã Formatting Issues</h4>
                            <ul style="padding-left: 1.2rem; margin: 0; color: var(--text-muted);">
                                ${issues.length ? issues.map(i => `<li>${i}</li>`).join('') : '<li>No major issues found.</li>'}
                            </ul>
                         </div>
                    </div>
                `;

                modalBody.innerHTML = content;
                document.getElementById('detailsModal').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                showToast("Error loading details", "error");
            }
        }

        function closeModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('detailsModal').classList.add('hidden');
        }

        // Init
        fetchInterviews();

    </script>
</body>

</html>
