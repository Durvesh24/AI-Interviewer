<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Questions - AI Interview Coach</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Link CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Auth check BEFORE body renders -->
    <script>
        if (!sessionStorage.getItem('token')) {
            window.location.href = 'login.html';
        }
    </script>
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span style="font-size: 2rem;">ðŸ¤–</span>
                <span>AI Interview Coach</span>
            </a>

            <button class="mobile-toggle" aria-label="Toggle Menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>

            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="index.html#features" class="nav-link">Features</a>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle Dark Mode">
                    <span>ðŸŒ™</span>
                </button>
                <button onclick="logout()" class="btn btn-secondary"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">Logout</button>
            </div>
        </div>
    </nav>

    <div class="app-container" style="flex: 1; margin-top: 2rem; margin-bottom: 2rem;">
        <header class="text-center mb-4">
            <h1 id="pageTitle">Practice Questions</h1>
            <p id="pageSubtitle" style="color: var(--text-muted);">Simulate a real interview experience tailored to your
                role.</p>
        </header>

        <main style="max-width: 800px; margin: 0 auto; width: 100%;">

            <!-- Setup Card -->
            <div class="card setup-card">
                <div class="form-group" id="roleContainer">
                    <label for="role">Target Role</label>
                    <input type="text" id="role" placeholder="e.g. Software Engineer Intern" class="input-field">
                </div>

                <div class="form-group" id="difficultyContainer">
                    <label for="difficulty">Difficulty Level</label>
                    <select id="difficulty" class="select-field">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="questionCount">Number of Questions</label>
                    <input type="number" id="questionCount" min="1" max="10" value="3" class="input-field">
                </div>

                <button onclick="startInterview()" class="btn btn-primary" style="width: 100%;">ðŸš€ Start
                    Session</button>
            </div>

            <!-- Question Area -->
            <div id="questionBox" class="card question-card hidden">
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span id="progressText" style="font-weight: 600; color: var(--primary);">Question 1</span>
                    </div>
                    <div
                        style="background: rgba(128,128,128,0.2); height: 8px; border-radius: var(--radius-full); overflow: hidden;">
                        <div id="progressBar"
                            style="width: 0%; height: 100%; background: var(--primary); transition: width 0.5s ease;">
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    Current Challenge
                    <button onclick="speakText(document.getElementById('questionText').innerText, this)"
                        class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">ðŸ”Š Read
                        Question</button>
                </h3>
                <div id="questionText"
                    style="font-size: 1.25rem; font-weight: 500; margin-bottom: 1.5rem; line-height: 1.6;"></div>

                <textarea id="answer" class="textarea-field"
                    placeholder="Type your confident answer here..."></textarea>

                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <!-- Voice Input -->
                    <button id="micBtn" onclick="toggleVoiceInput(this, 'answer')" class="btn btn-secondary"
                        style="border-color: var(--primary); color: var(--primary);">
                        ðŸŽ¤ Speak Answer
                    </button>
                    <button onclick="submitAnswer()" class="btn btn-primary" id="submitBtn">Submit Answer</button>
                </div>

                <div id="loading" style="display:none; margin-top:20px; text-align:center;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: var(--text-muted);">Analyzing your response...</p>
                </div>
            </div>

            <!-- Feedback -->
            <div id="feedbackBox" class="card hidden" style="margin-top: 1.5rem; border-left: 4px solid var(--accent);">
            </div>

            <!-- Final Summary -->
            <div id="summaryBox" class="card hidden text-center">
                <h3>ðŸŽ‰ Session Complete!</h3>
                <div id="finalScore" style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 1rem 0;">
                </div>
                <p id="finalVerdict" style="color: var(--text-muted); padding: 0 1rem;"></p>
                <div style="margin-top: 2rem;">
                    <a href="dashboard.html" class="btn btn-secondary">Go to Dashboard</a>
                </div>
            </div>

            <!-- Ideal Answers -->
            <div class="ideal-answers-section hidden" style="margin-top: 2rem; text-align: center;">
                <button onclick="getIdealAnswers()" class="btn btn-secondary">View Ideal Answers</button>
                <div id="comparisonBox" class="card hidden" style="margin-top:1.5rem; text-align: left;"></div>
            </div>

        </main>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-grid">
            <div class="footer-col">
                <div class="logo" style="margin-bottom: 1rem;">ðŸ¤– AI Interview Coach</div>
            </div>
            <div class="footer-col">
                <h4>Quick Links</h4>
                <a href="dashboard.html">Dashboard</a>
                <a href="index.html">Home</a>
            </div>
            <div class="footer-col">
                <p>&copy; <span id="currentYear"></span></p>
            </div>
        </div>
    </footer>

    <!-- Main JS -->
    <script src="js/main.js"></script>
    <script src="js/voice-interview.js"></script>

    <script>
        // Copied Logic from original mock-interview.html but cleaned up
        // Note: API_BASE_URL resolution is better handled centrally or relatively if proxying, 
        // but keeping it here for continuity.

        let interviewId = "";
        let questions = [];
        let currentQuestion = 0;
        let userAnswers = [];
        const token = sessionStorage.getItem('token');

        const getApiBaseUrl = () => {
            const h = window.location.hostname;
            if (h === 'localhost' || h === '127.0.0.1') return 'http://localhost:5000';
            return '';
        };
        const API_BASE_URL = getApiBaseUrl();

        window.addEventListener('load', () => {
            const retakeData = sessionStorage.getItem('retakeData');
            if (retakeData) {
                const { role, questions } = JSON.parse(retakeData);
                document.getElementById("role").value = role;
                if (questions && questions.length) document.getElementById("questionCount").value = questions.length;
                setTimeout(startInterview, 100);
            } else {
                const savedRole = sessionStorage.getItem('targetRole');
                if (savedRole) document.getElementById("role").value = savedRole;

                const resumeContext = sessionStorage.getItem('resumeContext');
                if (resumeContext) {
                    document.getElementById("roleContainer").style.display = 'none';
                    document.getElementById("difficultyContainer").style.display = 'none';
                    document.getElementById("pageTitle").innerText = "Resume Analysis";
                    document.getElementById("pageSubtitle").innerText = `Deep dive into questions based on your resume.`;
                }
            }
        });

        async function startInterview() {
            const roleInput = document.getElementById("role");
            const difficultyInput = document.getElementById("difficulty");
            let role = roleInput.value;
            let difficulty = difficultyInput.value;
            const btn = document.querySelector(".setup-card .btn-primary");
            const questionCount = parseInt(document.getElementById("questionCount").value) || 3;

            const resumeContext = sessionStorage.getItem('resumeContext');
            const savedRole = sessionStorage.getItem('targetRole');
            let type = "standard";

            if (resumeContext) {
                type = "resume";
                role = savedRole || role;
                difficulty = "Intermediate";
            }

            if (!role) { showToast("Please enter a job role.", 'error'); return; }

            // Loading
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner" style="width:16px;height:16px;"></span> Setting up...`;

            // Retake Check
            let passedQuestions = null;
            const retakeData = sessionStorage.getItem('retakeData');
            if (retakeData) passedQuestions = JSON.parse(retakeData).questions;

            try {
                const res = await fetch(`${API_BASE_URL}/start-interview`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ role, difficulty, questionCount, resumeContext, passedQuestions, type })
                });

                // Cleanup
                if (resumeContext) sessionStorage.removeItem('resumeContext');
                if (savedRole) sessionStorage.removeItem('targetRole');
                if (retakeData) sessionStorage.removeItem('retakeData');

                if (res.status === 401) { logout(); return; }

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Server error");

                interviewId = data.interviewId;
                questions = data.questions;
                currentQuestion = 0;

                document.getElementById("questionBox").classList.remove("hidden");
                document.querySelector(".setup-card").classList.add("hidden");
                document.getElementById("questionBox").scrollIntoView({ behavior: 'smooth' });
                showQuestion();

            } catch (error) {
                console.error(error);
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerText = "ðŸš€ Start Session";
            }
        }

        function showQuestion() {
            document.getElementById("questionText").innerText = questions[currentQuestion];
            document.getElementById("answer").value = "";
            document.getElementById("feedbackBox").classList.add("hidden");
            document.getElementById("loading").style.display = "none";

            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById("progressBar").style.width = `${progress}%`;
            document.getElementById("progressText").innerText = `Question ${currentQuestion + 1} of ${questions.length}`;
        }

        async function submitAnswer() {
            const answer = document.getElementById("answer").value;
            const btn = document.getElementById("submitBtn");

            if (!answer.trim()) { showToast("Please type an answer.", 'error'); return; }

            const loading = document.getElementById("loading");
            btn.disabled = true;
            loading.style.display = "block";

            try {
                const res = await fetch(`${API_BASE_URL}/answer`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ interviewId, question: questions[currentQuestion], answer })
                });

                const data = await res.json();
                userAnswers.push(answer);
                loading.style.display = "none";
                btn.disabled = false;

                const fb = document.getElementById("feedbackBox");
                fb.innerHTML = `<strong>Feedback:</strong> ${data.feedback}`;
                fb.classList.remove("hidden");
                fb.scrollIntoView({ behavior: "smooth" });

                currentQuestion++;
                if (currentQuestion < questions.length) {
                    setTimeout(() => {
                        showQuestion();
                        fb.classList.add("hidden");
                    }, 4000);
                } else {
                    setTimeout(() => {
                        document.getElementById("questionBox").classList.add("hidden");
                        fb.classList.add("hidden");
                        getSummary();
                        document.querySelector(".ideal-answers-section").classList.remove("hidden");
                    }, 4000);
                }
            } catch (e) {
                loading.style.display = "none";
                btn.disabled = false;
                showToast("Error submitting answer", 'error');
            }
        }

        async function getSummary() {
            try {
                const res = await fetch(`${API_BASE_URL}/interview-summary`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ interviewId })
                });
                const data = await res.json();
                document.getElementById("finalScore").innerText = `${data.averageScore} / 10`;
                document.getElementById("finalVerdict").innerText = data.verdict;
                document.getElementById("summaryBox").classList.remove("hidden");
            } catch (e) { console.error(e); }
        }

        async function getIdealAnswers() {
            try {
                const res = await fetch(`${API_BASE_URL}/ideal-answers`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ interviewId })
                });
                const data = await res.json();
                const box = document.getElementById("comparisonBox");

                let html = "";
                data.idealAnswers.forEach((item, i) => {
                    html += `
                        <div style="margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
                            <h4 style="color: var(--primary);">Q${i + 1}: ${item.question}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: var(--radius-sm);">
                                    <strong>Your Answer</strong>
                                    <p>${userAnswers[i] || "No answer"}</p>
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: var(--radius-sm);">
                                    <strong style="color: #10B981;">Ideal Answer</strong>
                                    <p>${item.idealAnswer}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                box.innerHTML = html;
                box.classList.remove("hidden");
            } catch (e) { showToast("Error loading answers", 'error'); }
        }
    </script>
</body>

</html>
